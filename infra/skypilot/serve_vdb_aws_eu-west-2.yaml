---
resources:
  cloud: aws  # The cloud to use (optional).

  # The region to use (optional). Auto-failover will be disabled
  # if this is specified.
  region: eu-west-2

  memory: 30+
  cpus: 4+

file_mounts:
  /qdrant_bge-base-en:
    source: s3://discovery-gen-ai/indexes/nesta_way/qdrant_bge-base-en
    store: s3
    persistent: True
    mode: COPY

setup: |
  conda activate slackbot
  if [ $? -ne 0 ]; then
    conda create -n slackbot python=3.9 poetry -y
    conda deactivate
    conda activate slackbot
  fi

  poetry --version || echo "Check if poetry is installed!"

  git clone -b 49-slack-bot git@github.com:nestauk/discovery_generative_ai.git || true

  cd discovery_generative_ai
  make init
  pip install sentence-transformers fastapi -y
  sudo docker info
  docker pull qdrant/qdrant

  echo 'Setting up nginx with public ipv4 at...'
  export ADDRESS=`ec2metadata --public-ipv4`
  echo $ADDRESS

  sudo apt-get update -y && sudo apt install nginx -y
  cd /etc/nginx/sites-enabled/
  echo \
  "server {
    listen 80;
    server_name $ADDRESS;
    location / {
      proxy_pass http://0.0.0.0:8000;
    }
  }
  " | sudo tee fastapi_nginx

run: |
  echo 'Starting qdrant service...'
  docker run -p 6333:6333 \
    -v /qdrant_bge-base-en:/qdrant/storage \
    qdrant/qdrant

  conda activate slackbot
  echo 'Starting nginx service...'
  sudo service nginx restart
  echo 'Starting slackbot app...'
  cd ~/sky_workdir/discovery_generative_ai/src/slackbot
  python -u -m serve_vdb 2>&1 | tee api_server.log &

  echo 'Waiting for slackbot to start...'
  while ! `cat api_server.log | grep -q 'Uvicorn running on'`; do sleep 1; done
  echo 'Slackbot started!'
